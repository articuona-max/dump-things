<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dump Things I Have Done</title>
<style>
    body {
        background: #050505;
        color: #00ff9c;
        font-family: monospace;
        margin: 0;
    }
    .wrap {
        max-width: 900px;
        margin: 60px auto;
        padding: 20px;
    }
    h1 {
        text-align: center;
        color: #00ffaa;
        letter-spacing: 2px;
    }
    textarea {
        width: 100%;
        height: 200px;
        background: #020202;
        color: #00ff9c;
        border: 1px solid #0f3;
        padding: 12px;
        font-size: 14px;
        resize: none;
    }
    button, input {
        background: #020202;
        color: #00ff9c;
        border: 1px solid #0f3;
        padding: 10px;
        margin-top: 10px;
        cursor: pointer;
        width: 100%;
    }
    pre {
        background: #020202;
        border: 1px solid #0f3;
        padding: 15px;
        margin-top: 20px;
        white-space: pre-wrap;
    }
    .hidden { display:none; }
</style>
</head>
<body>

<div class="wrap" id="login">
    <h1>üîê AUTH REQUIRED</h1>
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Enter</button>
</div>

<div class="wrap hidden" id="app">
    <h1>üìù DUMP THINGS I HAVE DONE</h1>

    <textarea id="entry" placeholder="What did you do today?"></textarea>
    <button onclick="addEntry()">Append Today</button>

    <button onclick="exportDump()">Export Encrypted Dump</button>
    <input type="file" onchange="importDump(event)">

    <pre id="log"></pre>
</div>

<script>
let cryptoKey;
let dump = [];
let usedDates = new Set();

/* ---------- CRYPTO ---------- */
async function deriveKey(password, salt) {
    const enc = new TextEncoder();
    const baseKey = await crypto.subtle.importKey(
        "raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
    );
}

async function encrypt(text) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const data = new TextEncoder().encode(text);
    const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        cryptoKey,
        data
    );
    return { iv: [...iv], data: [...new Uint8Array(encrypted)] };
}

async function decrypt(payload) {
    const iv = new Uint8Array(payload.iv);
    const data = new Uint8Array(payload.data);
    const decrypted = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        cryptoKey,
        data
    );
    return new TextDecoder().decode(decrypted);
}

/* ---------- APP ---------- */
async function login() {
    const pass = document.getElementById("password").value;
    const salt = new TextEncoder().encode("dump-things-static-salt");
    cryptoKey = await deriveKey(pass, salt);
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
}

function today() {
    return new Date().toISOString().split("T")[0];
}

function addEntry() {
    const date = today();
    if (usedDates.has(date)) {
        alert("Entry for today already exists.");
        return;
    }

    const text = document.getElementById("entry").value.trim();
    if (!text) return;

    const timestamp = new Date().toISOString();
    dump.push({ date, timestamp, text });
    usedDates.add(date);
    document.getElementById("entry").value = "";
    render();
}

function render() {
    document.getElementById("log").textContent =
        dump.map(e =>
            `[${e.date} ${e.timestamp}]\n${e.text}\n`
        ).join("\n");
}

async function exportDump() {
    const encrypted = await encrypt(JSON.stringify(dump));
    const blob = new Blob([JSON.stringify(encrypted)], { type: "application/octet-stream" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "dump.enc";
    a.click();
}

async function importDump(e) {
    const file = e.target.files[0];
    const text = await file.text();
    const payload = JSON.parse(text);
    const decrypted = await decrypt(payload);
    dump = JSON.parse(decrypted);
    usedDates = new Set(dump.map(e => e.date));
    render();
}
</script>

</body>
</html>
